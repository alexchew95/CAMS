<!doctype html>
<html lang="en" dir="ltr">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<meta http-equiv="Content-Language" content="en" />
	<meta name="msapplication-TileColor" content="#2d89ef">
	<meta name="theme-color" content="#4188c9">
	<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="mobile-web-app-capable" content="yes">
	<meta name="HandheldFriendly" content="True">
	<meta name="MobileOptimized" content="320">
	<link rel="icon" href="./favicon.ico" type="image/x-icon" />
	<link rel="shortcut icon" type="image/x-icon" href="./favicon.ico" />
	<!-- Generated: 2018-04-16 09:29:05 +0200 -->
	<title>LPTS Login - Admin Page</title>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,300i,400,400i,500,500i,600,600i,700,700i&amp;subset=latin-ext">
	<script src="./assets/js/require.min.js"></script>
	<script src="https://code.jquery.com/jquery.min.js"></script>
	<script>
		requirejs.config({
			baseUrl: '.'
		});

	</script>
	<!-- Dashboard Core -->
	<link href="./assets/css/dashboard.css" rel="stylesheet" />
	<script src="./assets/js/dashboard.js"></script>

	<!-- c3.js Charts Plugin -->
	<link href="./assets/plugins/charts-c3/plugin.css" rel="stylesheet" />
	<script src="./assets/plugins/charts-c3/plugin.js"></script>
	<!-- Google Maps Plugin -->
	<link href="./assets/plugins/maps-google/plugin.css" rel="stylesheet" />
	<script src="./assets/plugins/maps-google/plugin.js"></script>
	<!-- Input Mask Plugin -->
	<script src="./assets/plugins/input-mask/plugin.js"></script>


</head>

<body class="">
	<div class="page">
		<div class="page-single">
			<div class="container">
				<div class="row">
					<div class="col col-login mx-auto">

						<form class="card" action="" method="post">

							<div class="card-body p-6">
								<a class="header-brand" href="./index.html">
									<img src="./demo/brand/lpts-logotype.png" class="header-brand-img" alt="tabler logo">
								</a>
								<div class="card-login">User Login</div>
								<div class="form-group">
									<label class="form-label">Email address</label>
									<input type="email" class="form-control" id="txtEmail" aria-describedby="emailHelp" placeholder="Enter email"
									 required>
								</div>
								<div class="form-group">
									<label class="form-label">Password</label>
									<input type="password" class="form-control" id="txtPwd" placeholder="Password" required>
								</div>
								<label id="lblMessages" class="text-danger"></label>

							</div>
							<div class="form-footer">
								<button type="submit" id="btnLogin" class="btn btn-primary btn-block" data-loading-text="Processing...<span></span>">Sign
									in</button>
							</div>
							<!-- <div class="form-footer">
								<input type="button" onclick="location.href='sign_up.html';" class="btn btn-primary btn-block" value="New user? Click here to sign up!"
								/>
							</div> -->

					</div>
					</form>
				</div>
			</div>
		</div>
	</div>
	</div>


	<!--Modal for sign up - End-->
	<script>
		//var APIUrl = 'http://localhost/lpts-ci/api/';
	var APIUrl = 'https://lpts-ci.herokuapp.com/api/';
		$(document).ready(function () {
			$("#btnLogin").click(function (event) {
				var $this = $(this);
				var loadingText = '<i class="fa fa-circle-o-notch fa-spin"></i> loading...';

				if ($("form")[0].checkValidity()) {
					event.preventDefault();

					if ($(this).html() !== loadingText) {
						$this.data('original-text', $(this).html());
						$this.html(loadingText);
					}

					//reset label msg
					$("#lblMessages").text("");
					$(this).prop('valid', true);
					$('.form-control').prop('disabled', true); //disable form input
					require(['bcrypt'], function (bcrypt) {
						const saltRounds = 10;
						const myPlaintextPassword = $("#txtPwd").val()
						//salt = bcrypt.genSaltSync(saltRounds);
						salt = "$2a$10$s8r.zIlaXpYFB9DbbISgEu";
						//console.log(salt);
						hash = bcrypt.hashSync(myPlaintextPassword, salt);

						$.ajax({

							url: APIUrl + 'login',
							type: 'POST',

							data: {
								"email": $("#txtEmail").val(),
								"password": hash,
							},
							dataType: 'JSON',
							success: function (data) {
								sessionStorage.setItem('token', data.token);
								sessionStorage.setItem('email', data.email);
								sessionStorage.setItem('name', data.name);
								sessionStorage.setItem('role', data.role);
								sessionStorage.setItem('userId', data.userId);

								window.location = "home.html";
								//name = sessionStorage.getItem("name");
								// $("#lblMessages").text(name);  from storageSession
								//  $("#lblMessages").text(data.name); from data(return from login_post)
							},
							statusCode: {
								400: function (request, status, error) {
									$(this).prop('disabled', false);

									//console.log("401 - Login incorrect");
									//console.log(error);
									$("#lblMessages").text("Sorry, your account have been deactivated.");
									$('.form-control').prop('disabled', false);
									$this.html($this.data('original-text'));

								},
								401: function (request, status, error) {
									$(this).prop('disabled', false);

									//console.log("401 - Login incorrect");
									//console.log(error);
									$("#lblMessages").text("Login Incorrect - Please try again!");
									$('.form-control').prop('disabled', false);
									$this.html($this.data('original-text'));

								}
							},
							error: function (xhr, ajaxOptions, thrownError) {
								var errorMsg = 'Ajax request failed: ' + xhr.responseText;
								console.log(errorMsg);
							}
						});
						//console.log(localStorage);
					});
				}

			});

		});

	</script>
</body>

</html>